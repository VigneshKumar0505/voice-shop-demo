<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice Shop ‚Äî Milestone 2 (Telecom)</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --fg:#e2e8f0; --muted:#94a3b8; --accent:#22c55e; --warn:#ef4444; --line:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:980px;margin:32px auto;padding:20px}
    h1{font-size:1.5rem;margin:0 0 12px}
    .card{background:#111827aa;border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
    button{border:0;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
    .mic{background:var(--accent);color:#08210f} .mic.stop{background:var(--warn);color:#fff}
    .status{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--panel);border:1px solid var(--line);color:var(--muted);margin-left:8px}
    .status.online{color:var(--accent);border-color:#14532d} .status.offline{color:var(--warn);border-color:#3f1d1d}
    .area{min-height:54px;padding:12px;border-radius:10px;background:var(--panel);border:1px dashed #334155}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .prod{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
    .title{font-weight:700} .price{color:#cbd5e1;margin-left:6px}
    .caps{font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .cart{position:sticky;top:16px}
    .pill{padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--line);color:var(--muted);font-size:.8rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üéôÔ∏è Voice Shop ‚Äî Telecom Assistant</h1>

    <div class="card">
      <button id="toggle" class="mic">Start Listening</button>
      <span id="live" class="status offline">Mic: idle</span>
      <span id="secure" class="status">Secure context: ‚Ä¶</span>
      <p style="margin:8px 0 0;color:#cbd5e1">Try: <code>find broadband under one thousand</code> ¬∑ <code>show sd-wan</code> ¬∑ <code>find routers under three thousand</code> ¬∑ <code>add the second to cart</code> ¬∑ <code>what's in my cart</code></p>
    </div>

    <div class="card">
      <div class="row">
        <div style="flex:1">
          <div class="caps">You said</div>
          <div id="you" class="area" aria-live="polite"></div>
        </div>
        <div style="flex:1">
          <div class="caps">Assistant replied</div>
          <div id="bot" class="area" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <div class="row" style="align-items:flex-start">
      <div style="flex:2" class="card">
        <div class="row" style="justify-content:space-between">
          <div class="caps">Results</div>
          <div id="count" class="pill">0 items</div>
        </div>
        <div id="results" class="grid"></div>
      </div>

      <div style="flex:1;min-width:280px" class="card cart">
        <div class="caps">Cart</div>
        <div id="cartList" class="area" style="min-height:120px"></div>
        <div class="row" style="margin-top:8px">
          <div id="cartTotal" class="pill">Total: ‚Çπ0</div>
          <button id="btnCheckout">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- State ----------
    let PRODUCTS = [];
    let RESULTS = [];
    const CART = [];

    // ---------- DOM ----------
    const you = document.getElementById('you');
    const bot = document.getElementById('bot');
    const live = document.getElementById('live');
    const secure = document.getElementById('secure');
    const toggleBtn = document.getElementById('toggle');
    const resultsEl = document.getElementById('results');
    const countEl = document.getElementById('count');
    const cartList = document.getElementById('cartList');
    const cartTotal = document.getElementById('cartTotal');
    const btnCheckout = document.getElementById('btnCheckout');

    secure.textContent = 'Secure context: ' + (window.isSecureContext ? 'yes' : 'no');

    // ---------- Load products.json ----------
    async function loadProducts() {
      try {
        const res = await fetch('products.json', { cache: 'no-store' });
        PRODUCTS = await res.json();
        RESULTS = PRODUCTS.slice(0, 6);
        renderResults(RESULTS);
      } catch (e) {
        speak('I could not load the product catalog.');
        console.error(e);
      }
    }

    function renderResults(list) {
      resultsEl.innerHTML = '';
      countEl.textContent = `${list.length} item${list.length!==1?'s':''}`;
      list.forEach((p, idx) => {
        const el = document.createElement('div');
        el.className = 'prod';
        el.innerHTML = `
          <div class="title">${idx+1}. ${p.title}</div>
          <div class="caps">${p.category} ¬∑ ${p.brand} ¬∑ ${p.sku}</div>
          <div style="margin:6px 0">
            <span class="price">‚Çπ${p.price}</span>
            ${p.speed_mbps ? `<span class="pill">${p.speed_mbps} Mbps</span>` : ''}
            ${p.contract ? `<span class="pill">${p.contract}</span>` : ''}
          </div>
          <ul style="margin:6px 0 10px 18px; color:#cbd5e1">
            ${(p.features||[]).slice(0,3).map(f=>`<li>${f}</li>`).join('')}
          </ul>
          <button data-idx="${idx}" class="addBtn">Add to cart</button>
        `;
        resultsEl.appendChild(el);
      });
      // wire add buttons
      document.querySelectorAll('.addBtn').forEach(b=>{
        b.onclick = (e)=>{
          const i = parseInt(e.currentTarget.getAttribute('data-idx'), 10);
          addToCart(list[i]);
        };
      });
    }

    function renderCart() {
      if (CART.length === 0) {
        cartList.textContent = 'Cart is empty.';
        cartTotal.textContent = 'Total: ‚Çπ0';
        return;
      }
      cartList.innerHTML = CART.map((c,i)=>`${i+1}. ${c.title} ‚Äî ‚Çπ${c.price}`).join('<br>');
      const total = CART.reduce((s,p)=>s+p.price,0);
      cartTotal.textContent = `Total: ‚Çπ${total}`;
    }

    function addToCart(p) {
      CART.push(p);
      speak(`Added ${p.title} for ‚Çπ${p.price} to your cart.`);
      renderCart();
    }

    btnCheckout.onclick = ()=>{
      if (CART.length===0) { speak('Your cart is empty.'); return; }
      const total = CART.reduce((s,p)=>s+p.price,0);
      speak(`You have ${CART.length} item${CART.length>1?'s':''} for a total of ‚Çπ${total}. Ready to place the order?`);
    };

    // ---------- Voice (STT/TTS) ----------
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec, listening=false;

    function speak(text){
      bot.textContent = text;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-IN';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    if (SpeechRec){
      rec = new SpeechRec();
      rec.lang = 'en-IN';
      rec.continuous = false;
      rec.interimResults = true;

      rec.onresult = (event)=>{
        let final = '';
        for (const r of event.results){
          const t = r[0].transcript;
          you.textContent = t; // live
          if (r.isFinal) final += t + ' ';
        }
        final = final.trim();
        if (final) handleUtterance(final);
      };
      rec.onend = ()=>{ if (listening) try{rec.start()}catch{} };
    } else {
      live.textContent = 'Mic not supported in this browser.';
      toggleBtn.disabled = true;
    }

    toggleBtn.onclick = ()=>{
      if (!rec) return;
      listening = !listening;
      if (listening){ rec.start(); live.textContent='Mic: listening‚Ä¶'; toggleBtn.textContent='Stop Listening'; toggleBtn.classList.add('stop'); }
      else { rec.stop(); live.textContent='Mic: idle'; toggleBtn.textContent='Start Listening'; toggleBtn.classList.remove('stop'); }
    };

    // ---------- NLU (very simple rules) ----------
    function handleUtterance(raw){
      const text = raw.toLowerCase();
      // help
      if (/what can you do|help/.test(text)){
        speak('I can find broadband, SD-WAN, routers, switches, IoT and security products, filter by price, and add items to your cart.');
        return;
      }
      // show cart
      if (/what'?s in my cart|show cart|cart/.test(text)){
        if (CART.length===0) speak('Your cart is empty.');
        else speak(`You have ${CART.length} item${CART.length>1?'s':''} in your cart. Total ${CART.reduce((s,p)=>s+p.price,0)} rupees.`);
        return;
      }
      // add by ordinal: "add the second"
      const ord = text.match(/add the (\d+)(st|nd|rd|th)?/);
      if (ord){
        const i = parseInt(ord[1],10)-1;
        if (RESULTS[i]) addToCart(RESULTS[i]); else speak('I could not find that item number on the page.');
        return;
      }
      if (/add .* to cart/.test(text)){
        // naive: add first visible result
        if (RESULTS[0]) addToCart(RESULTS[0]); else speak('No results to add.');
        return;
      }
      // search category & price: "find routers under 3000", "show sd-wan", "find broadband 300 mbps", etc.
      if (/find|show|look for/.test(text)){
        const category = /(broadband|sd[\s-]?wan|router[s]?|switch(?:es)?|iot|security)/.exec(text)?.[1]?.replace(/\s|-/g,'') || null;
        const priceCap = /under (\d{3,6})/.exec(text)?.[1] ? parseInt(/under (\d{3,6})/.exec(text)[1],10) : null;
        const speed = /(\d{2,4})\s?mbps/.exec(text)?.[1] ? parseInt(/(\d{2,4})\s?mbps/.exec(text)[1],10) : null;
        const brand = /(orangetel|orangebiz|orangesecure|netbee|switchly|sensehub)/.exec(text)?.[1] || null;

        let list = PRODUCTS.slice();

        if (category){
          const normCat = category.replace('sdwan','sdwan').replace('routers','router').replace('switches','switch');
          list = list.filter(p=>p.category===normCat);
        }
        if (priceCap) list = list.filter(p=> p.price <= priceCap);
        if (speed) list = list.filter(p=> p.speed_mbps && p.speed_mbps >= speed);
        if (brand) list = list.filter(p=> p.brand.toLowerCase()===brand);

        if (list.length===0){ speak('No matching products found.'); resultsEl.innerHTML=''; countEl.textContent='0 items'; return; }

        RESULTS = list;
        renderResults(list);
        // short spoken summary
        const first = list[0];
        let summary = `${list.length} result${list.length>1?'s':''}`;
        if (category) summary += ` for ${category}`;
        if (priceCap) summary += ` under ${priceCap} rupees`;
        if (speed) summary += ` at ${speed} megabits per second or more`;
        speak(`${summary}. First is ${first.title} at ‚Çπ${first.price}.`);
        return;
      }

      // stop speaking
      if (/stop|be quiet|silence/.test(text)){
        window.speechSynthesis.cancel(); bot.textContent='‚èπÔ∏è Stopped speaking.'; return;
      }

      // default
      speak('Try: find broadband under one thousand; show SD-WAN; add the second to cart; what‚Äôs in my cart.');
    }

    // ---------- Init ----------
    loadProducts();
  </script>
</body>
</html>
